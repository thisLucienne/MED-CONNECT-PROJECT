<div class="patients-page">
    <!-- En-tête -->
    <div class="page-header">
        <div class="header-left">
            <h1>Patients</h1>
            <p class="subtitle">Gestion des patients de la plateforme</p>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-section">
        <div class="stat-card total">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21M13 7C13 9.20914 11.2091 11 9 11C6.79086 11 5 9.20914 5 7C5 4.79086 6.79086 3 9 3C11.2091 3 13 4.79086 13 7ZM24 21V19C23.9993 18.1137 23.7044 17.2528 23.1614 16.5523C22.6184 15.8519 21.8581 15.3516 21 15.13M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45768C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ totalPatients }}</h3>
                <p>Total</p>
            </div>
        </div>

        <div class="stat-card active">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ activePatients }}</h3>
                <p>Actifs</p>
            </div>
        </div>

        <div class="stat-card pending">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ inactivePatients }}</h3>
                <p>En attente</p>
            </div>
        </div>

        <div class="stat-card urgent">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ urgentPatients }}</h3>
                <p>Cas urgents</p>
            </div>
        </div>
    </div>

    <!-- Section filtres et recherche -->
    <div class="filters-section">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                <path d="M20 20L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <input type="text" placeholder="Rechercher un patient par nom, prénom, email ou téléphone..."
                [(ngModel)]="searchQuery" (input)="onSearch()" class="search-input" />
        </div>

        <div class="filter-controls">
            <select class="filter-select" [(ngModel)]="selectedStatut" (change)="onFilterChange()">
                <option value="">Tous les statuts</option>
                <option value="actif">Actif</option>
                <option value="inactif">Inactif</option>
                <option value="urgent">Urgent</option>
            </select>

            <select class="filter-select" [(ngModel)]="selectedCondition" (change)="onFilterChange()">
                <option value="">Toutes les conditions</option>
                <option value="Hypertension">Hypertension</option>
                <option value="Diabète">Diabète</option>
                <option value="Asthme">Asthme</option>
                <option value="Arthrite">Arthrite</option>
                <option value="Migraine chronique">Migraine chronique</option>
            </select>

            <button class="btn-reset" (click)="resetFilters()" *ngIf="selectedStatut || selectedCondition">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                Réinitialiser
            </button>

            <div class="view-toggle">
                <button class="toggle-btn" [class.active]="viewMode === 'table'" (click)="setViewMode('table')" title="Vue tableau">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" />
                        <rect x="14" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" />
                        <rect x="3" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" />
                        <rect x="14" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" />
                    </svg>
                </button>
                <button class="toggle-btn" [class.active]="viewMode === 'cards'" (click)="setViewMode('cards')" title="Vue cartes">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="3" width="18" height="4" stroke="currentColor" stroke-width="2" />
                        <rect x="3" y="10" width="18" height="4" stroke="currentColor" stroke-width="2" />
                        <rect x="3" y="17" width="18" height="4" stroke="currentColor" stroke-width="2" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Liste des patients -->
    <div class="patients-list" *ngIf="viewMode === 'table'">
        <div class="table-container">
            <table class="patients-table">
                <thead>
                    <tr>
                        <th>ID Patient</th>
                        <th>Patient</th>
                        <th>Âge</th>
                        <th>Dernière consultation</th>
                        <th>Condition</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let patient of patients$ | async">
                        <td class="patient-id">{{ patient.id }}</td>
                        <td class="patient-name">
                            <div class="name-wrapper">
                                <div class="avatar">
                                    {{ patient.prenom.charAt(0) }}{{ patient.nom.charAt(0) }}
                                </div>
                                <div class="name-info">
                                    <p class="name">{{ patient.prenom }} {{ patient.nom }}</p>
                                    <p class="nss">{{ patient.numeroSecuriteSociale }}</p>
                                </div>
                            </div>
                        </td>
                        <td>{{ calculateAge(patient.dateNaissance) }} ans</td>
                        <td>{{ patient.derniereConsultation || 'Aucune' }}</td>
                        <td>{{ patient.condition || 'Non spécifiée' }}</td>
                        <td>
                            <button class="status-badge" 
                                [class.active]="patient.statut === 'actif'"
                                [class.inactive]="patient.statut === 'inactif'"
                                [class.urgent]="patient.statut === 'urgent'" 
                                (click)="toggleStatus(patient)">
                                {{ patient.statut }}
                            </button>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn edit" (click)="editPatient(patient)" title="Modifier">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <path
                                            d="M11 4H7C5.89543 4 5 4.89543 5 6V18C5 19.1046 5.89543 20 7 20H19C20.1046 20 21 19.1046 21 18V14M15.5 3.5L20.5 8.5M9 15L13.5 10.5L18.5 5.5C19.3284 4.67157 19.3284 3.32843 18.5 2.5C17.6716 1.67157 16.3284 1.67157 15.5 2.5L10.5 7.5L6 12L5 15L9 15Z"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                    </svg>
                                </button>
                                <button class="action-btn delete" (click)="deletePatient(patient)" title="Supprimer">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <path
                                            d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Vue en cartes -->
    <div class="patients-cards" *ngIf="viewMode === 'cards'">
        <div class="cards-grid">
            <div class="patient-card" *ngFor="let patient of patients$ | async">
                <div class="card-header">
                    <div class="patient-info">
                        <div class="avatar">
                            {{ patient.prenom.charAt(0) }}{{ patient.nom.charAt(0) }}
                        </div>
                        <div class="patient-details">
                            <h3>{{ patient.prenom }} {{ patient.nom }}</h3>
                            <p class="patient-id">{{ patient.id }}</p>
                        </div>
                    </div>
                    <button class="status-badge" 
                        [class.active]="patient.statut === 'actif'"
                        [class.inactive]="patient.statut === 'inactif'"
                        [class.urgent]="patient.statut === 'urgent'" 
                        (click)="toggleStatus(patient)">
                        {{ patient.statut }}
                    </button>
                </div>

                <div class="card-body">
                    <div class="info-row">
                        <span class="label">Âge</span>
                        <span class="value">{{ calculateAge(patient.dateNaissance) }} ans</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Téléphone</span>
                        <span class="value">{{ patient.telephone }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Email</span>
                        <span class="value">{{ patient.email }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Dernière consultation</span>
                        <span class="value">{{ patient.derniereConsultation || 'Aucune' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Condition</span>
                        <span class="value">{{ patient.condition || 'Non spécifiée' }}</span>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="action-btn edit" (click)="editPatient(patient)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M11 4H7C5.89543 4 5 4.89543 5 6V18C5 19.1046 5.89543 20 7 20H19C20.1046 20 21 19.1046 21 18V14M15.5 3.5L20.5 8.5M9 15L13.5 10.5L18.5 5.5C19.3284 4.67157 19.3284 3.32843 18.5 2.5C17.6716 1.67157 16.3284 1.67157 15.5 2.5L10.5 7.5L6 12L5 15L9 15Z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Modifier
                    </button>
                    <button class="action-btn delete" (click)="deletePatient(patient)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Formulaire -->
    <div class="modal-overlay" *ngIf="showForm" (click)="closeForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ isEditing ? 'Modifier le patient' : 'Ajouter un nouveau patient' }}</h2>
                <button class="close-btn" (click)="closeForm()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>

            <form class="patient-form" (ngSubmit)="onSubmit()">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nom">Nom *</label>
                        <input type="text" id="nom" [(ngModel)]="patientForm.nom" name="nom" required
                            placeholder="Entrez le nom" />
                    </div>

                    <div class="form-group">
                        <label for="prenom">Prénom *</label>
                        <input type="text" id="prenom" [(ngModel)]="patientForm.prenom" name="prenom" required
                            placeholder="Entrez le prénom" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateNaissance">Date de naissance *</label>
                        <input type="date" id="dateNaissance" [(ngModel)]="patientForm.dateNaissance"
                            name="dateNaissance" required />
                    </div>

                    <div class="form-group">
                        <label for="sexe">Sexe *</label>
                        <select id="sexe" [(ngModel)]="patientForm.sexe" name="sexe" required>
                            <option value="">Sélectionner</option>
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="telephone">Téléphone *</label>
                        <input type="tel" id="telephone" [(ngModel)]="patientForm.telephone" name="telephone" required
                            placeholder="+237 6 XX XX XX XX" />
                    </div>

                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" [(ngModel)]="patientForm.email" name="email" required
                            placeholder="exemple@email.com" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse" [(ngModel)]="patientForm.adresse" name="adresse"
                        placeholder="Ville, Quartier" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nss">Numéro de Sécurité Sociale</label>
                        <input type="text" id="nss" [(ngModel)]="patientForm.numeroSecuriteSociale"
                            name="numeroSecuriteSociale" placeholder="XXXXXXXXXXX" />
                    </div>

                    <div class="form-group">
                        <label for="groupeSanguin">Groupe Sanguin</label>
                        <select id="groupeSanguin" [(ngModel)]="patientForm.groupeSanguin" name="groupeSanguin">
                            <option value="">Sélectionner</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" (click)="closeForm()">
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary">
                        {{ isEditing ? 'Mettre à jour' : 'Ajouter' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>