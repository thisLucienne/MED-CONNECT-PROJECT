<!-- 
  EXPLICATION :
  Interface de messagerie type WhatsApp/Messenger
  
  Structure :
  - Gauche : Liste des conversations
  - Droite : Chat actif avec messages
  
  Fonctionnalités :
  - Auto-scroll vers le bas
  - Messages en temps réel
  - Badge non lus
  - Recherche et filtres
-->

<div class="messagerie-page">
    <!-- En-tête -->
    <div class="page-header">
        <div class="header-left">
            <h1>Messagerie</h1>
            <p class="subtitle">
                Conversations avec patients et médecins
                <span class="unread-badge" *ngIf="(totalUnreadCount$ | async) as unread">
                    {{ unread }} non lu{{ unread > 1 ? 's' : '' }}
                </span>
            </p>
        </div>
    </div>

    <!-- Conteneur principal -->
    <div class="messagerie-container">

        <!-- PARTIE GAUCHE : Liste des conversations -->
        <div class="conversations-sidebar">

            <!-- Recherche et filtres -->
            <div class="sidebar-header">
                <div class="search-box">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                        <path d="M20 20L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <input type="text" placeholder="Rechercher une conversation..." [(ngModel)]="searchQuery"
                        (input)="onSearch()" />
                </div>

                <div class="filter-tabs">
                    <button class="filter-tab" [class.active]="selectedFilter === 'all'"
                        (click)="selectedFilter = 'all'; onFilterChange()">
                        Tous
                    </button>
                    <button class="filter-tab" [class.active]="selectedFilter === 'patient'"
                        (click)="selectedFilter = 'patient'; onFilterChange()">
                        Patients
                    </button>
                    <button class="filter-tab" [class.active]="selectedFilter === 'medecin'"
                        (click)="selectedFilter = 'medecin'; onFilterChange()">
                        Médecins
                    </button>
                </div>
            </div>

            <!-- Liste des conversations -->
            <div class="conversations-list">
                <div class="conversation-item" *ngFor="let conversation of conversations$ | async"
                    [class.active]="selectedConversation?.id === conversation.id"
                    [class.has-unread]="conversation.unreadCount > 0" (click)="selectConversation(conversation)">
                    <!-- Avatar -->
                    <div class="conversation-avatar">
                        <div class="avatar-circle" [class.patient]="conversation.participantType === 'patient'"
                            [class.medecin]="conversation.participantType === 'medecin'">
                            {{ conversation.participantName.charAt(0) }}
                        </div>
                        <span class="online-indicator" *ngIf="conversation.isActive"></span>
                    </div>

                    <!-- Infos conversation -->
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <h3 class="conversation-name">{{ conversation.participantName }}</h3>
                            <span class="conversation-time">{{ getRelativeTime(conversation.lastMessageTime) }}</span>
                        </div>

                        <div class="conversation-preview">
                            <p class="last-message">{{ conversation.lastMessage }}</p>
                            <span class="unread-count" *ngIf="conversation.unreadCount > 0">
                                {{ conversation.unreadCount }}
                            </span>
                        </div>

                        <span class="participant-badge"
                            [ngClass]="getParticipantBadgeClass(conversation.participantType)">
                            {{ getParticipantIcon(conversation.participantType) }}
                            {{ conversation.participantType === 'patient' ? 'Patient' : 'Médecin' }}
                        </span>
                    </div>

                    <!-- Actions -->
                    <div class="conversation-actions" (click)="$event.stopPropagation()">
                        <button class="action-icon" (click)="archiveConversation(conversation)" title="Archiver">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M5 8H19M5 8V18C5 19.1046 5.89543 20 7 20H17C18.1046 20 19 19.1046 19 18V8M5 8L7 4H17L19 8M10 12H14"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                        </button>
                        <button class="action-icon delete" (click)="deleteConversation(conversation)" title="Supprimer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- État vide -->
                <div class="empty-conversations" *ngIf="(conversations$ | async)?.length === 0">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M8 10H16M8 14H12M21 12C21 16.4183 16.9706 20 12 20C10.4607 20 9.01172 19.6565 7.74467 19.0511L3 20L4.39499 16.28C3.51156 15.0423 3 13.5743 3 12C3 7.58172 7.02944 4 12 4C16.9706 4 21 7.58172 21 12Z"
                            stroke="currentColor" stroke-width="2" />
                    </svg>
                    <p>Aucune conversation</p>
                </div>
            </div>
        </div>

        <!-- PARTIE DROITE : Chat actif -->
        <div class="chat-area">

            <!-- Aucune conversation sélectionnée -->
            <div class="no-conversation-selected" *ngIf="!selectedConversation">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                    <path
                        d="M8 10H16M8 14H12M21 12C21 16.4183 16.9706 20 12 20C10.4607 20 9.01172 19.6565 7.74467 19.0511L3 20L4.39499 16.28C3.51156 15.0423 3 13.5743 3 12C3 7.58172 7.02944 4 12 4C16.9706 4 21 7.58172 21 12Z"
                        stroke="currentColor" stroke-width="2" />
                </svg>
                <h3>Sélectionnez une conversation</h3>
                <p>Choisissez une conversation dans la liste pour commencer à échanger</p>
            </div>

            <!-- Chat actif -->
            <div class="chat-active" *ngIf="selectedConversation">

                <!-- En-tête du chat -->
                <div class="chat-header">
                    <div class="chat-participant">
                        <div class="avatar-circle small"
                            [class.patient]="selectedConversation.participantType === 'patient'"
                            [class.medecin]="selectedConversation.participantType === 'medecin'">
                            {{ selectedConversation.participantName.charAt(0) }}
                        </div>
                        <div class="participant-details">
                            <h3>{{ selectedConversation.participantName }}</h3>
                            <span class="participant-type"
                                [ngClass]="getParticipantBadgeClass(selectedConversation.participantType)">
                                {{ selectedConversation.participantType === 'patient' ? 'Patient' : 'Médecin' }}
                            </span>
                        </div>
                    </div>

                    <div class="chat-actions">
                        <button class="icon-btn" title="Rechercher">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                                <path d="M20 20L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </button>
                        <button class="icon-btn" title="Plus d'options">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="5" r="1.5" fill="currentColor" />
                                <circle cx="12" cy="12" r="1.5" fill="currentColor" />
                                <circle cx="12" cy="19" r="1.5" fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-container" #messagesContainer>
                    <div class="messages-list">

                        <!-- Date separator -->
                        <div class="date-separator">
                            <span>Aujourd'hui</span>
                        </div>

                        <!-- Messages -->
                        <div *ngFor="let message of selectedConversation.messages" class="message-wrapper"
                            [class.my-message]="isMyMessage(message)" [class.their-message]="!isMyMessage(message)">
                            <div class="message-bubble">
                                <p class="message-content">{{ message.content }}</p>
                                <div class="message-footer">
                                    <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span>
                                    <!-- Indicateur de lecture (pour mes messages) -->
                                    <span class="read-indicator" *ngIf="isMyMessage(message)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            [class.read]="message.isRead">
                                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" />
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Zone de saisie -->
                <div class="message-input-area">
                    <button class="icon-btn attach" title="Joindre un fichier">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M21.4396 11.0002L12.4396 20.0002C10.3396 22.1002 6.88957 22.1002 4.78957 20.0002C2.68957 17.9002 2.68957 14.4502 4.78957 12.3502L13.7896 3.35019C15.2296 1.91019 17.5796 1.91019 19.0196 3.35019C20.4596 4.79019 20.4596 7.14019 19.0196 8.58019L10.5596 17.0402C9.83957 17.7602 8.65957 17.7602 7.93957 17.0402C7.21957 16.3202 7.21957 15.1402 7.93957 14.4202L15.7896 6.58019"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>

                    <textarea class="message-input" placeholder="Tapez votre message..." [(ngModel)]="messageContent"
                        (keypress)="onKeyPress($event)" rows="1"></textarea>

                    <button class="send-button" (click)="sendMessage()" [disabled]="!messageContent.trim()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>

            </div>
        </div>

    </div>
</div>