<!-- 
  EXPLICATION :
  Cette vue affiche la liste des dossiers médicaux.
  Elle est plus complexe car elle affiche des données de 3 entités :
  - Dossier
  - Patient
  - Médecin
-->

<div class="dossiers-page">
  <!-- En-tête avec statistiques -->
  <div class="page-header">
    <div class="header-left">
      <h1>Dossiers Médicaux</h1>
      <p class="subtitle">Gestion des dossiers médicaux de la plateforme</p>
    </div>
  </div>

  <!-- Cartes statistiques -->
  <div class="stats-cards" *ngIf="statistics$ | async as stats">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="stat-info">
        <p class="stat-label">Total Dossiers</p>
        <p class="stat-value">{{ stats.total }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12C9 11.518 8.886 11.062 8.684 10.658M8.684 13.342L12 16.658M8.684 13.342C8.04 14.72 6.458 15.656 4.659 15.656C2.086 15.656 0 13.57 0 11C0 8.43 2.086 6.344 4.659 6.344C6.458 6.344 8.04 7.28 8.684 8.658M8.684 10.658L12 7.342M8.684 10.658C8.886 10.062 9 9.518 9 9C9 6.43 11.086 4.344 13.659 4.344C16.232 4.344 18.318 6.43 18.318 9C18.318 9.518 18.204 10.062 18.002 10.658M12 16.658C12.518 16.658 13.062 16.544 13.466 16.342M12 16.658C11.482 16.658 10.938 16.544 10.534 16.342M12 7.342C12.518 7.342 13.062 7.456 13.466 7.658M12 7.342C11.482 7.342 10.938 7.456 10.534 7.658" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="stat-info">
        <p class="stat-label">Dossiers Partagés</p>
        <p class="stat-value">{{ stats.ouverts }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon orange">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 8V12M12 16H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="stat-info">
        <p class="stat-label">Consultations</p>
        <p class="stat-value">{{ stats.totalConsultations }}</p>
      </div>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-input-wrapper">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
        <path d="M20 20L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input 
        type="text" 
        placeholder="Rechercher par patient, médecin ou diagnostic..."
        [(ngModel)]="searchQuery"
        (input)="onSearch()"
        class="search-input"
      />
    </div>

    <div class="filter-group">
      <select 
        [(ngModel)]="selectedStatut" 
        (change)="onFilterByStatut()"
        class="filter-select"
      >
        <option value="">Tous les statuts</option>
        <option value="ouvert">Ouvert</option>
        <option value="fermé">Fermé</option>
        <option value="archivé">Archivé</option>
      </select>

      <button class="btn-reset" (click)="resetFilters()" *ngIf="searchQuery || selectedStatut">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Réinitialiser
      </button>
    </div>
  </div>

  <!-- Liste des dossiers -->
  <div class="dossiers-list">
    <div class="table-container">
      <table class="dossiers-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Patient</th>
            <th>Médecin Responsable</th>
            <th>Diagnostic</th>
            <th>Consultations</th>
            <th>Dernière MAJ</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let dossier of dossiers$ | async">
            <td class="dossier-id">{{ dossier.id }}</td>

            <!-- Patient -->
            <td>
              <div class="person-info">
                <div class="avatar patient">
                  {{ dossier.patientPrenom.charAt(0) }}{{ dossier.patientNom.charAt(0) }}
                </div>
                <div class="info-text">
                  <p class="name">{{ dossier.patientPrenom }} {{ dossier.patientNom }}</p>
                  <p class="meta">{{ dossier.groupeSanguin || 'N/A' }}</p>
                </div>
              </div>
            </td>

            <!-- Médecin -->
            <td>
              <div class="person-info">
                <div class="avatar medecin">
                  {{ dossier.medecinPrenom.charAt(0) }}{{ dossier.medecinNom.charAt(0) }}
                </div>
                <div class="info-text">
                  <p class="name">Dr. {{ dossier.medecinPrenom }} {{ dossier.medecinNom }}</p>
                </div>
              </div>
            </td>

            <!-- Diagnostic -->
            <td>
              <span class="diagnostic-badge" *ngIf="dossier.diagnosticPrincipal">
                {{ dossier.diagnosticPrincipal }}
              </span>
              <span class="no-data" *ngIf="!dossier.diagnosticPrincipal">Aucun diagnostic</span>
            </td>

            <!-- Consultations -->
            <td class="text-center">
              <span class="consultation-count">{{ dossier.nombreConsultations }}</span>
            </td>

            <!-- Date modification -->
            <td>{{ dossier.dateModification }}</td>

            <!-- Statut -->
            <td>
              <select 
                [value]="dossier.statut" 
                (change)="changeStatut(dossier, $any($event.target).value)"
                class="status-select"
                [ngClass]="getStatutClass(dossier.statut)"
              >
                <option value="ouvert">Ouvert</option>
                <option value="fermé">Fermé</option>
                <option value="archivé">Archivé</option>
              </select>
            </td>

            <!-- Actions -->
            <td>
              <div class="actions">
                <button 
                  class="action-btn view" 
                  (click)="viewDetails(dossier)" 
                  title="Voir détails"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M2 12C2 12 5 5 12 5C19 5 22 12 22 12C22 12 19 19 12 19C5 19 2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>

                <button 
                  class="action-btn add" 
                  (click)="openConsultationForm(dossier)" 
                  title="Ajouter consultation"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>

                <button 
                  class="action-btn delete" 
                  (click)="deleteDossier(dossier)" 
                  title="Supprimer"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<!-- 
  MODAL 1 : CRÉATION DE DOSSIER MÉDICAL
  Permet de créer un nouveau dossier en sélectionnant un patient et un médecin
-->
<div class="modal-overlay" *ngIf="showDossierForm" (click)="closeDossierForm()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Créer un nouveau dossier médical</h2>
      <button class="close-btn" (click)="closeDossierForm()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <form class="dossier-form" (ngSubmit)="onSubmitDossier()">
      <!-- Sélection Patient et Médecin -->
      <div class="form-row">
        <div class="form-group">
          <label for="patient">Patient *</label>
          <select id="patient" [(ngModel)]="dossierForm.patientId" name="patientId" required>
            <option value="">Sélectionner un patient</option>
            <option *ngFor="let patient of patients$ | async" [value]="patient.id">
              {{ patient.prenom }} {{ patient.nom }} ({{ patient.id }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="medecin">Médecin responsable *</label>
          <select id="medecin" [(ngModel)]="dossierForm.medecinId" name="medecinId" required>
            <option value="">Sélectionner un médecin</option>
            <option *ngFor="let medecin of medecins$ | async" [value]="medecin.id">
              Dr. {{ medecin.prenom }} {{ medecin.nom }} - {{ medecin.specialite }}
            </option>
          </select>
        </div>
      </div>

      <!-- Diagnostic et Groupe sanguin -->
      <div class="form-row">
        <div class="form-group">
          <label for="diagnostic">Diagnostic principal</label>
          <input 
            type="text" 
            id="diagnostic" 
            [(ngModel)]="dossierForm.diagnosticPrincipal" 
            name="diagnosticPrincipal"
            placeholder="Ex: Hypertension artérielle"
          />
        </div>

        <div class="form-group">
          <label for="groupeSanguin">Groupe sanguin</label>
          <select id="groupeSanguin" [(ngModel)]="dossierForm.groupeSanguin" name="groupeSanguin">
            <option value="">Sélectionner</option>
            <option *ngFor="let groupe of groupesSanguins" [value]="groupe">{{ groupe }}</option>
          </select>
        </div>
      </div>

      <!-- Allergies -->
      <div class="form-group">
        <label>Allergies</label>
        <div class="tags-input">
          <div class="tags-container">
            <span class="tag" *ngFor="let allergie of dossierForm.allergies; let i = index">
              {{ allergie }}
              <button type="button" (click)="removeAllergie(i)" class="tag-remove">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </span>
          </div>
          <div class="input-with-button">
            <input 
              type="text" 
              [(ngModel)]="newAllergie" 
              name="newAllergie"
              placeholder="Ajouter une allergie"
              (keyup.enter)="addAllergie()"
            />
            <button type="button" (click)="addAllergie()" class="btn-add-tag">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Antécédents médicaux -->
      <div class="form-group">
        <label>Antécédents médicaux</label>
        <div class="tags-input">
          <div class="tags-container">
            <span class="tag" *ngFor="let antecedent of dossierForm.antecedentsMedicaux; let i = index">
              {{ antecedent }}
              <button type="button" (click)="removeAntecedent(i)" class="tag-remove">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </span>
          </div>
          <div class="input-with-button">
            <input 
              type="text" 
              [(ngModel)]="newAntecedent" 
              name="newAntecedent"
              placeholder="Ajouter un antécédent"
              (keyup.enter)="addAntecedent()"
            />
            <button type="button" (click)="addAntecedent()" class="btn-add-tag">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="closeDossierForm()">
          Annuler
        </button>
        <button type="submit" class="btn-primary">
          Créer le dossier
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 
  MODAL 2 : AJOUT DE CONSULTATION
  Permet d'ajouter une consultation à un dossier existant
-->
<div class="modal-overlay" *ngIf="showConsultationForm" (click)="closeConsultationForm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Ajouter une consultation</h2>
        <p class="modal-subtitle" *ngIf="selectedDossier">
          Patient: {{ selectedDossier.patientPrenom }} {{ selectedDossier.patientNom }}
        </p>
      </div>
      <button class="close-btn" (click)="closeConsultationForm()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <form class="consultation-form" (ngSubmit)="onSubmitConsultation()">
      <div class="form-group">
        <label for="motif">Motif de consultation *</label>
        <input 
          type="text" 
          id="motif" 
          [(ngModel)]="consultationForm.motif" 
          name="motif" 
          required
          placeholder="Ex: Contrôle de routine"
        />
      </div>

      <div class="form-group">
        <label for="diagnostic">Diagnostic *</label>
        <textarea 
          id="diagnostic" 
          [(ngModel)]="consultationForm.diagnostic" 
          name="diagnostic" 
          required
          rows="3"
          placeholder="Diagnostic du médecin"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="prescription">Prescription médicale</label>
        <textarea 
          id="prescription" 
          [(ngModel)]="consultationForm.prescription" 
          name="prescription"
          rows="3"
          placeholder="Médicaments prescrits et posologie"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="notes">Notes complémentaires</label>
        <textarea 
          id="notes" 
          [(ngModel)]="consultationForm.notes" 
          name="notes"
          rows="2"
          placeholder="Notes additionnelles"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="closeConsultationForm()">
          Annuler
        </button>
        <button type="submit" class="btn-primary">
          Ajouter la consultation
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 
  MODAL 3 : DÉTAILS DU DOSSIER
  Affiche tous les détails d'un dossier avec l'historique des consultations
-->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Détails du dossier médical</h2>
      <button class="close-btn" (click)="closeDetailModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="detail-content" *ngIf="selectedDossier">
      <!-- Informations générales -->
      <div class="detail-section">
        <h3 class="section-title">Informations générales</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ID Dossier:</span>
            <span class="info-value">{{ selectedDossier.id }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Date création:</span>
            <span class="info-value">{{ selectedDossier.dateCreation }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Patient:</span>
            <span class="info-value">{{ selectedDossier.patientPrenom }} {{ selectedDossier.patientNom }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Médecin:</span>
            <span class="info-value">Dr. {{ selectedDossier.medecinPrenom }} {{ selectedDossier.medecinNom }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Groupe sanguin:</span>
            <span class="info-value">{{ selectedDossier.groupeSanguin || 'Non renseigné' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Statut:</span>
            <span class="info-value">
              <span class="status-badge-detail" [ngClass]="getStatutClass(selectedDossier.statut)">
                {{ selectedDossier.statut }}
              </span>
            </span>
          </div>
        </div>
      </div>

      <!-- Diagnostic principal -->
      <div class="detail-section" *ngIf="selectedDossier.diagnosticPrincipal">
        <h3 class="section-title">Diagnostic principal</h3>
        <p class="diagnostic-text">{{ selectedDossier.diagnosticPrincipal }}</p>
      </div>

      <!-- Allergies -->
      <div class="detail-section" *ngIf="selectedDossier.allergies && selectedDossier.allergies.length > 0">
        <h3 class="section-title">Allergies</h3>
        <div class="tags-list">
          <span class="tag danger" *ngFor="let allergie of selectedDossier.allergies">
            {{ allergie }}
          </span>
        </div>
      </div>

      <!-- Antécédents -->
      <div class="detail-section" *ngIf="selectedDossier.antecedentsMedicaux && selectedDossier.antecedentsMedicaux.length > 0">
        <h3 class="section-title">Antécédents médicaux</h3>
        <div class="tags-list">
          <span class="tag warning" *ngFor="let antecedent of selectedDossier.antecedentsMedicaux">
            {{ antecedent }}
          </span>
        </div>
      </div>

      <!-- Historique des consultations -->
      <div class="detail-section">
        <div class="section-header-with-action">
          <h3 class="section-title">
            Historique des consultations ({{ selectedDossier.nombreConsultations }})
          </h3>
          <button class="btn-small-primary" (click)="openConsultationForm(selectedDossier); closeDetailModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Ajouter
          </button>
        </div>

        <div class="consultations-timeline" *ngIf="selectedDossier.consultations && selectedDossier.consultations.length > 0">
          <div class="consultation-card" *ngFor="let consultation of selectedDossier.consultations">
            <div class="consultation-header">
              <span class="consultation-date">{{ consultation.date }}</span>
              <span class="consultation-id">{{ consultation.id }}</span>
            </div>
            
            <div class="consultation-body">
              <div class="consultation-field">
                <strong>Motif:</strong>
                <p>{{ consultation.motif }}</p>
              </div>
              
              <div class="consultation-field">
                <strong>Diagnostic:</strong>
                <p>{{ consultation.diagnostic }}</p>
              </div>
              
              <div class="consultation-field" *ngIf="consultation.prescription">
                <strong>Prescription:</strong>
                <p>{{ consultation.prescription }}</p>
              </div>
              
              <div class="consultation-field" *ngIf="consultation.notes">
                <strong>Notes:</strong>
                <p>{{ consultation.notes }}</p>
              </div>

              <div class="consultation-field" *ngIf="consultation.examens && consultation.examens.length > 0">
                <strong>Examens:</strong>
                <div class="tags-list">
                  <span class="tag info" *ngFor="let examen of consultation.examens">
                    {{ examen }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="!selectedDossier.consultations || selectedDossier.consultations.length === 0">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <p>Aucune consultation enregistrée</p>
          <button class="btn-link" (click)="openConsultationForm(selectedDossier); closeDetailModal()">
            Ajouter la première consultation
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>