<div class="messagerie-container">
  <!-- Sidebar avec liste des conversations -->
  <aside class="conversations-sidebar">
    <!-- Header sidebar -->
    <div class="sidebar-header">
      <h2>Messagerie</h2>
      <button class="btn-new-message" (click)="openNewMessage()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <!-- Barre de recherche -->
    <div class="search-conversations">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="currentColor"/>
      </svg>
      <input type="text" placeholder="Rechercher une conversation..." [(ngModel)]="searchQuery" (input)="filterConversations()">
    </div>

    <!-- Filtres -->
    <div class="conversation-filters">
      <button class="filter-tab" [class.active]="currentFilter === 'all'" (click)="setFilter('all')">
        Tous
      </button>
      <button class="filter-tab" [class.active]="currentFilter === 'unread'" (click)="setFilter('unread')">
        Non lus ({{ unreadCount }})
      </button>
      <button class="filter-tab" [class.active]="currentFilter === 'archived'" (click)="setFilter('archived')">
        Archivés
      </button>
    </div>

    <!-- Liste des conversations -->
    <div class="conversations-list">
      @for (conversation of filteredConversations; track conversation.id) {
        <div class="conversation-item" 
             [class.active]="selectedConversation?.id === conversation.id"
             [class.unread]="conversation.unreadCount > 0"
             (click)="selectConversation(conversation)">
          <div class="conversation-avatar">
            <img [src]="conversation.avatar" [alt]="conversation.name">
            <span class="online-status" [class.online]="conversation.isOnline"></span>
          </div>
          <div class="conversation-content">
            <div class="conversation-header">
              <h4 class="conversation-name">{{ conversation.name }}</h4>
              <span class="conversation-time">{{ conversation.lastMessageTime }}</span>
            </div>
            <div class="conversation-preview">
              <p class="last-message">{{ conversation.lastMessage }}</p>
              @if (conversation.unreadCount > 0) {
                <span class="unread-badge">{{ conversation.unreadCount }}</span>
              }
            </div>
          </div>
        </div>
      }
    </div>
  </aside>

  <!-- Zone de chat principale -->
  <main class="chat-main">
    @if (selectedConversation) {
      <!-- Header du chat -->
      <div class="chat-header">
        <div class="chat-user-info">
          <button class="btn-back-mobile" (click)="closeMobileChat()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
            </svg>
          </button>
          <div class="user-avatar">
            <img [src]="selectedConversation.avatar" [alt]="selectedConversation.name">
            <span class="online-status" [class.online]="selectedConversation.isOnline"></span>
          </div>
          <div class="user-details">
            <h3>{{ selectedConversation.name }}</h3>
            <p class="user-status">
              @if (selectedConversation.isOnline) {
                <span class="status-online">En ligne</span>
              } @else if (selectedConversation.isTyping) {
                <span class="status-typing">En train d'écrire...</span>
              } @else {
                <span class="status-offline">Hors ligne</span>
              }
            </p>
          </div>
        </div>
        <div class="chat-actions">
          <button class="action-btn" (click)="startVideoCall()" title="Appel vidéo">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" fill="currentColor"/>
            </svg>
          </button>
          <button class="action-btn" (click)="startAudioCall()" title="Appel audio">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" fill="currentColor"/>
            </svg>
          </button>
          <button class="action-btn" (click)="openPatientDossier()" title="Voir le dossier">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" fill="currentColor"/>
            </svg>
          </button>
          <button class="action-btn" (click)="toggleChatOptions()" title="Plus d'options">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Zone des messages -->
      <div class="messages-container" #messagesContainer>
        <div class="messages-list">
          @for (message of selectedConversation.messages; track message.id) {
            <div class="message-wrapper" [class.sent]="message.isSent" [class.received]="!message.isSent">
              @if (!message.isSent) {
                <img [src]="selectedConversation.avatar" [alt]="selectedConversation.name" class="message-avatar">
              }
              <div class="message-bubble">
                @if (message.type === 'text') {
                  <p class="message-text">{{ message.content }}</p>
                } @else if (message.type === 'image') {
                  <div class="message-image">
                    <img [src]="message.content" alt="Image">
                  </div>
                } @else if (message.type === 'file') {
                  <div class="message-file">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                    </svg>
                    <div class="file-info">
                      <span class="file-name">{{ message.fileName }}</span>
                      <span class="file-size">{{ message.fileSize }}</span>
                    </div>
                  </div>
                }
                <div class="message-meta">
                  <span class="message-time">{{ message.time }}</span>
                  @if (message.isSent) {
                    <svg class="message-status" [class.read]="message.isRead" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
                    </svg>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Indicateur de saisie -->
        @if (selectedConversation.isTyping) {
          <div class="typing-indicator">
            <img [src]="selectedConversation.avatar" [alt]="selectedConversation.name" class="typing-avatar">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        }
      </div>

      <!-- Zone de saisie -->
      <div class="message-input-container">
        <button class="input-action-btn" (click)="attachFile()" title="Joindre un fichier">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" fill="currentColor"/>
          </svg>
        </button>
        <button class="input-action-btn" (click)="openEmoji()" title="Emoji">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" fill="currentColor"/>
          </svg>
        </button>
        <div class="message-input-wrapper">
          <textarea 
            class="message-input" 
            placeholder="Écrivez votre message..." 
            [(ngModel)]="messageText"
            (keydown)="handleEnterKey($event)"
            (input)="handleTyping()"
            rows="1"></textarea>
        </div>
        <button class="btn-send" [disabled]="!messageText.trim()" (click)="sendMessage()">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    } @else {
      <!-- État vide -->
      <div class="empty-chat-state">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z" fill="currentColor"/>
        </svg>
        <h3>Sélectionnez une conversation</h3>
        <p>Choisissez une conversation dans la liste pour commencer à discuter</p>
      </div>
    }
  </main>

  <!-- Panneau d'informations (optionnel) -->
  @if (showInfoPanel && selectedConversation) {
    <aside class="info-panel">
      <div class="info-header">
        <h3>Informations</h3>
        <button class="btn-close-panel" (click)="closeInfoPanel()">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="info-content">
        <div class="info-user">
          <img [src]="selectedConversation.avatar" [alt]="selectedConversation.name" class="info-avatar">
          <h4>{{ selectedConversation.name }}</h4>
          <p>{{ selectedConversation.role }}</p>
        </div>
        <div class="info-section">
          <h5>Informations patient</h5>
          <div class="info-item">
            <span class="info-label">ID Patient</span>
            <span class="info-value">{{ selectedConversation.patientId }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Âge</span>
            <span class="info-value">{{ selectedConversation.age }} ans</span>
          </div>
          <div class="info-item">
            <span class="info-label">Dernière consultation</span>
            <span class="info-value">{{ selectedConversation.lastConsultation }}</span>
          </div>
        </div>
        <div class="info-actions">
          <button class="info-action-btn" (click)="openPatientDossier()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" fill="currentColor"/>
            </svg>
            Voir le dossier
          </button>
          <button class="info-action-btn" (click)="scheduleAppointment()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z" fill="currentColor"/>
            </svg>
            Prendre RDV
          </button>
          <button class="info-action-btn danger" (click)="archiveConversation()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z" fill="currentColor"/>
            </svg>
            Archiver
          </button>
        </div>
      </div>
    </aside>
  }
</div>
